# MyMTR 架构设计

## 项目概述

MyMTR 是一个带 IP 地址地理位置解析的网络诊断工具，结合了 traceroute 和 ping 的功能，并在每一跳显示 IP 的地理位置信息。

## 设计目标

1. **功能完整**：支持 ICMP/UDP 探测，实时显示延迟、丢包率、地理位置
2. **高性能**：并发探测，微秒级 IP 查询
3. **易用性**：支持 TUI 实时刷新、CLI 单次输出、JSON 格式输出
4. **可扩展**：支持多种 IP 数据库（ip2region、GeoIP2、纯真等）

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLI / TUI Layer                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Cobra     │  │  Bubbletea  │  │     JSON Output         │  │
│  │   CLI       │  │  TUI        │  │                         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Core Engine                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     MTR Controller                       │    │
│  │  - 协调探测器和 IP 解析器                                  │    │
│  │  - 管理探测生命周期                                        │    │
│  │  - 聚合统计数据                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐      │
│  │   Prober    │      │  Stats      │      │  GeoIP      │      │
│  │   探测器     │      │  统计器     │      │  解析器     │      │
│  └─────────────┘      └─────────────┘      └─────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Infrastructure Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ ICMP Socket │  │ UDP Socket  │  │  IP Database            │  │
│  │ (raw)       │  │             │  │  (ip2region/GeoIP2)     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
mymtr/
├── cmd/
│   └── mymtr/
│       └── main.go              # 程序入口
├── internal/
│   ├── cli/
│   │   ├── root.go              # 根命令
│   │   └── flags.go             # 命令行参数
│   ├── tui/
│   │   ├── app.go               # TUI 应用
│   │   ├── model.go             # TUI 数据模型
│   │   └── view.go              # TUI 视图渲染
│   ├── mtr/
│   │   ├── controller.go        # MTR 控制器
│   │   ├── prober.go            # 探测器接口
│   │   ├── icmp_prober.go       # ICMP 探测实现
│   │   ├── udp_prober.go        # UDP 探测实现
│   │   ├── stats.go             # 统计计算
│   │   └── hop.go               # 跳数数据结构
│   └── geoip/
│       ├── resolver.go          # IP 解析器接口
│       ├── ip2region.go         # ip2region 实现
│       ├── geoip2.go            # MaxMind GeoIP2 实现
│       └── qqwry.go             # 纯真数据库实现
├── pkg/
│   └── types/
│       └── types.go             # 公共类型定义
├── data/
│   └── ip2region.xdb            # IP 数据库文件（可选，默认下载到用户缓存）
├── docs/
│   ├── architecture.md          # 架构设计
│   ├── technical-design.md      # 技术设计
│   └── api-design.md            # API 设计
├── go.mod
├── go.sum
└── Makefile
```

## 核心模块说明

### 1. CLI/TUI Layer

负责用户交互，提供三种输出模式：
- **CLI 模式**：单次执行，输出结果后退出
- **TUI 模式**：实时刷新的终端界面（默认）
- **JSON 模式**：结构化输出，方便程序处理

### 2. MTR Controller

核心控制器，负责：
- 解析目标主机（DNS 解析）
- 启动和停止探测循环
- 协调 Prober 和 GeoIP Resolver
- 汇总统计数据并推送给 UI

### 3. Prober (探测器)

发送探测包并接收响应：
- **ICMP Prober**：使用原始套接字发送 ICMP Echo Request
- **UDP Prober**：发送 UDP 包到高端口，等待 ICMP Port Unreachable

### 4. Stats (统计器)

计算每一跳的统计数据：
- 发送/接收包数
- 丢包率
- RTT（最小/平均/最大/标准差）
- 最近 N 次探测结果

### 5. GeoIP Resolver (IP 解析器)

IP 地理位置解析，支持多种后端：
- **ip2region**：国内 IP 准确，性能极高
- **GeoIP2**：MaxMind 数据库，国际 IP 覆盖好
- **纯真 (QQWry)**：经典国内 IP 数据库

## 数据流

```
┌──────────┐     ┌────────────┐     ┌─────────┐     ┌──────────┐
│  用户输入 │ ──▶ │ Controller │ ──▶ │ Prober  │ ──▶ │ 网络探测  │
│  目标地址 │     │            │     │         │     │          │
└──────────┘     └────────────┘     └─────────┘     └──────────┘
                       │                                  │
                       │                                  │
                       ▼                                  ▼
                ┌────────────┐                    ┌──────────┐
                │   GeoIP    │ ◀─── IP 地址 ◀──── │ ICMP 响应 │
                │  Resolver  │                    │          │
                └────────────┘                    └──────────┘
                       │
                       ▼
                ┌────────────┐     ┌─────────┐
                │   Stats    │ ──▶ │ TUI/CLI │ ──▶ 用户看到结果
                │  聚合统计   │     │  渲染    │
                └────────────┘     └─────────┘
```

## 并发模型

```
Main Goroutine
      │
      ├──▶ Probe Loop Goroutine (每个 TTL 一个)
      │         │
      │         └──▶ 发送探测包 ──▶ 等待响应 ──▶ 更新统计
      │
      ├──▶ Receiver Goroutine
      │         │
      │         └──▶ 监听 ICMP 响应 ──▶ 匹配探测请求 ──▶ 计算 RTT
      │
      └──▶ UI Refresh Goroutine
                │
                └──▶ 定时刷新界面 ──▶ 渲染统计数据
```

## 配置选项

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `-c, --count` | 0 (无限) | 每跳探测次数 |
| `-i, --interval` | 1s | 探测间隔 |
| `-m, --max-hops` | 30 | 最大跳数 |
| `-t, --timeout` | 1s | 单次探测超时 |
| `-p, --protocol` | icmp | 探测协议 (icmp/udp) |
| `-4, --ipv4` | true | 使用 IPv4 |
| `-6, --ipv6` | false | 使用 IPv6 |
| `--geoip` | ip2region | IP 数据库 (ip2region/geoip2/qqwry) |
| `--json` | false | JSON 格式输出 |
| `--no-tui` | false | 禁用 TUI，使用简单输出 |

## 权限处理

发送原始 ICMP 包需要特殊权限：

1. **Linux**：使用 `setcap cap_net_raw+ep` 授权
2. **macOS**：需要 root 权限或使用 UDP 模式
3. **非特权模式**：自动降级为 UDP 探测

```bash
# Linux 设置权限
sudo setcap cap_net_raw+ep ./mymtr

# 或使用 sudo
sudo ./mymtr google.com
```
